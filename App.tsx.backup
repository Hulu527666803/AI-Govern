
import React, { useState, useMemo, useEffect } from 'react';
import { Routes, Route, useNavigate, useLocation, useSearchParams, Navigate } from 'react-router-dom';
import { SourceSidebar } from './components/SourceSidebar';
import { AnalysisCenter } from './components/AnalysisCenter';
import { GovernanceStudio } from './components/GovernanceStudio';
import { DataSource, DataDomain, GovernanceResult, SourceType, AISettings, AIEngineType, Session } from './types';
import { performGovernanceAnalysis } from './services/aiService';
import { domainService } from './services/domainService';
import { sourceService } from './services/sourceService';
import { sessionService } from './services/sessionService';
import { httpClient } from './services/httpClient';
import { X, LayoutDashboard, Sun, Moon, Settings as SettingsIcon, Cpu, Globe, Save, ShieldCheck, Zap, Key, Lock, Unlock } from 'lucide-react';

// ä½¿ç”¨ static/img/system_icon.png å±•ç¤ºé¡¹ç›®æ ‡è¯†
const UinoLogo = ({ theme }: { theme: 'light' | 'dark' }) => (
  <div className="flex items-center group cursor-pointer" onClick={() => window.location.href = '/'}>
    <div className="relative flex items-center justify-center">
      <img 
        src="/img/system_icon.png" 
        alt="System Logo" 
        className="object-contain transition-all duration-500 group-hover:scale-110 group-hover:drop-shadow-[0_0_8px_rgba(59,130,246,0.5)]"
        style={{ width: '108px', height: '24px' }}
        onError={(e) => {
          console.error('Logo image failed to load from /img/system_icon.png');
          (e.target as HTMLImageElement).style.display = 'none';
        }}
      />
      {/* å“ç‰Œè£…é¥°å…‰æ™• */}
      <div className="absolute inset-0 bg-blue-500/10 blur-xl rounded-full opacity-0 group-hover:opacity-100 transition-opacity duration-500"></div>
    </div>
  </div>
);

class ErrorBoundary extends React.Component<{children: React.ReactNode, fallback?: React.ReactNode}, {hasError: boolean, error: any}> {
  constructor(props: any) {
    super(props);
    this.state = { hasError: false, error: null };
  }

  static getDerivedStateFromError(error: any) {
    return { hasError: true, error };
  }

  componentDidCatch(error: any, errorInfo: any) {
    console.error("Uncaught error:", error, errorInfo);
  }

  render() {
    if (this.state.hasError) {
      return this.props.fallback || (
        <div className="flex flex-col items-center justify-center h-full p-6 text-center">
          <div className="p-4 bg-red-50 text-red-600 rounded-xl border border-red-100 max-w-md">
            <h3 className="font-bold mb-2">ç»„ä»¶æ¸²æŸ“å¼‚å¸¸</h3>
            <p className="text-xs font-mono break-all">{this.state.error?.message}</p>
            <button 
              onClick={() => this.setState({ hasError: false })}
              className="mt-4 px-4 py-2 bg-white border border-red-200 rounded-lg text-xs hover:bg-red-50"
            >
              å°è¯•æ¢å¤
            </button>
          </div>
        </div>
      );
    }

    return this.props.children;
  }
}

const App: React.FC = () => {
  const [theme, setTheme] = useState<'light' | 'dark'>('dark');
  const [token, setTokenState] = useState(httpClient.getToken() || '');
  // TODO: ä¸´æ—¶é€»è¾‘ - Token é”å®šçŠ¶æ€ï¼Œç”¨äºæµ‹è¯•é˜¶æ®µã€‚åç»­åº”æ›¿æ¢ä¸ºæ­£å¼çš„ç™»å½•/è®¤è¯æµç¨‹ã€‚
  const [isTokenLocked, setIsTokenLocked] = useState(!!httpClient.getToken());
  const [domains, setDomains] = useState<DataDomain[]>([]);
  const [sources, setSources] = useState<DataSource[]>([]);
  const [activeDomainId, setActiveDomainId] = useState<string | null>(null);
  const [activeSessionId, setActiveSessionId] = useState<string | null>(null);
  const [sessions, setSessions] = useState<Session[]>([]);
  const [isCreatingSession, setIsCreatingSession] = useState(false);
  const [governanceResult, setGovernanceResult] = useState<GovernanceResult | null>(null);
  const [isAnalyzing, setIsAnalyzing] = useState(false);
  const [chatHistory, setChatHistory] = useState<{ role: 'user' | 'ai'; text: string; result?: GovernanceResult }[]>([]);
  const [selectedSource, setSelectedSource] = useState<DataSource | null>(null);
  
  // ğŸ”§ ä¼šè¯çº§åˆ«çš„çŠ¶æ€å­˜å‚¨ï¼šæ¯ä¸ªä¼šè¯ç»´æŠ¤è‡ªå·±çš„èŠå¤©å†å²å’Œåˆ†æçŠ¶æ€
  const [sessionStates, setSessionStates] = useState<{
    [sessionId: string]: {
      chatHistory: { role: 'user' | 'ai'; text: string; result?: GovernanceResult }[];
      isAnalyzing: boolean;
    }
  }>({});
  
  const [showSettings, setShowSettings] = useState(false);
  // AI é…ç½®ç°åœ¨ç”±åç«¯ç»Ÿä¸€ç®¡ç†ï¼Œå‰ç«¯åªä¿ç•™ç”¨äºæ˜¾ç¤º
  const [aiSettings, setAiSettings] = useState<AISettings>({
    engine: 'BACKEND' as AIEngineType, // æ ‡è¯†ä½¿ç”¨åç«¯é…ç½®
    baseUrl: '',
    modelName: 'ç”±åç«¯é…ç½®'
  });

  const navigate = useNavigate();
  const location = useLocation();
  const [searchParams] = useSearchParams();
  
  // è¯†åˆ«åµŒå…¥æ¨¡å¼ï¼šå½“ URL åŒ…å« mode=embedded æ—¶éšè—å¯¼èˆªæ å’Œä¾§è¾¹æ 
  const isEmbedded = searchParams.get('mode') === 'embedded';

  useEffect(() => {
    document.documentElement.className = theme;
  }, [theme]);

  // Token å˜åŒ–æ—¶åŠ è½½æ•°æ®
  useEffect(() => {
    if (token && isTokenLocked) {
      httpClient.setToken(token);
      domainService.getUserDomains()
        .then(data => {
          setDomains(data);
          if (data.length > 0) {
            if (!activeDomainId) {
              setActiveDomainId(data[0].id);
            }
          } else {
            setActiveDomainId(null);
            setActiveSessionId(null);
          }
        })
        .catch(err => console.error('åŠ è½½æ•°æ®åŸŸå¤±è´¥:', err));
    } else if (!token) {
      setDomains([]);
      setActiveDomainId(null);
      setActiveSessionId(null);
      setSources([]);
    }
  }, [token, isTokenLocked]);

  // åˆ‡æ¢åŸŸæ—¶åŠ è½½èµ„äº§å’Œä¼šè¯
  useEffect(() => {
    if (activeDomainId) {
      sourceService.getDomainSources(activeDomainId)
        .then(data => setSources(data))
        .catch(err => console.error('åŠ è½½èµ„äº§å¤±è´¥:', err));
        
      sessionService.getUserSessions(activeDomainId)
        .then(data => setSessions(data))
        .catch(err => console.error('åŠ è½½ä¼šè¯åˆ—è¡¨å¤±è´¥:', err));
    } else {
      setSources([]);
      setSessions([]);
    }
  }, [activeDomainId]);

  const handleTokenChange = (newToken: string) => {
    setTokenState(newToken);
  };

  const handleTokenLock = () => {
    if (token.trim()) {
      setIsTokenLocked(true);
      httpClient.setToken(token);
    }
  };

  const handleTokenUnlock = () => {
    // TODO: ä¸´æ—¶é€»è¾‘ - å…è®¸è§£é”ä»¥ä¿®æ”¹ Token
    setIsTokenLocked(false);
    setDomains([]);
    setActiveDomainId(null);
    setActiveSessionId(null);
    httpClient.setToken(''); // æ¸…é™¤æœ¬åœ°å­˜å‚¨çš„ Token
  };

  const saveSettings = (newSettings: AISettings) => {
    // AI é…ç½®ç°åœ¨ç”±åç«¯ç®¡ç†ï¼Œå‰ç«¯è®¾ç½®å·²ç¦ç”¨
    alert('âš ï¸ AI é…ç½®ç°åœ¨ç”±åç«¯ç»Ÿä¸€ç®¡ç†ï¼Œè¯·è”ç³»ç®¡ç†å‘˜ä¿®æ”¹ .env é…ç½®æ–‡ä»¶');
    setShowSettings(false);
  };

  const navItems = [
    { label: 'æ™ºèƒ½æ²»æ•°', path: '/governance' },
    { label: 'å¯¹è±¡ç®¡ç†', path: '/objects' },
    { label: 'ä¸šåŠ¡æœ¯è¯­', path: '/glossary' },
    { label: 'ä¸šåŠ¡çŸ¥è¯†', path: '/knowledge' },
    { label: 'ä¸šåŠ¡æŸ¥è¯¢', path: '/query' },
    { label: 'MCP æœåŠ¡', path: '/mcp' },
    { label: 'çƒ­æ•°æ®', path: '/hot-data' },
    { label: 'åˆ†æç®¡ç†', path: '/analytics' },
    { label: 'ç³»ç»Ÿç®¡ç†', path: '/system' }
  ];

  const activeDomain = useMemo(() => 
    domains.find(d => d.id === activeDomainId) || null
  , [domains, activeDomainId]);

  const activeDomainSources = useMemo(() => 
    sources.filter(s => s.domainId === activeDomainId)
  , [sources, activeDomainId]);

  const toggleTheme = () => {
    setTheme(prev => prev === 'light' ? 'dark' : 'light');
  };

  const handleAddDomain = async (name: string, description: string) => {
    if (!token) {
      alert('è¯·å…ˆè¾“å…¥ Token');
      return;
    }
    try {
      const newDomain = await domainService.createDomain(name, description);
      setDomains(prev => [newDomain, ...prev]);
      setActiveDomainId(newDomain.id);
      setActiveSessionId(null);
      setSelectedSource(null);
      console.log(`âœ… ä¸šåŠ¡åŸŸ "${name}" å·²åˆ›å»ºï¼ŒID: ${newDomain.id}`);
    } catch (error) {
      console.error('åˆ›å»ºä¸šåŠ¡åŸŸå¤±è´¥:', error);
      alert('åˆ›å»ºä¸šåŠ¡åŸŸå¤±è´¥');
    }
  };

  const handleDeleteDomain = async (id: string) => {
    if (window.confirm('ç¡®å®šè¦åˆ é™¤è¯¥ä¸šåŠ¡åŸŸå—ï¼Ÿè¿™å°†åŒæ—¶åˆ é™¤è¯¥åŸŸä¸‹çš„æ‰€æœ‰ä¼šè¯å’Œå†å²è®°å½•ã€‚')) {
      try {
        await domainService.deleteDomain(id);
        setDomains(prev => prev.filter(d => d.id !== id));
        if (activeDomainId === id) {
          setActiveDomainId(null);
          setActiveSessionId(null);
    setSelectedSource(null);
        }
      } catch (error) {
        console.error('åˆ é™¤ä¸šåŠ¡åŸŸå¤±è´¥:', error);
        alert('åˆ é™¤ä¸šåŠ¡åŸŸå¤±è´¥');
      }
    }
  };

  const handleSelectDomain = (id: string) => {
    // ğŸ”§ ä¿å­˜å½“å‰ä¼šè¯çŠ¶æ€
    if (activeSessionId) {
      saveCurrentSessionState(activeSessionId);
    }
    
    setActiveDomainId(id);
    setActiveSessionId(null); // åˆ‡æ¢åŸŸæ—¶é‡ç½®ä¼šè¯
    setSelectedSource(null); 
    setChatHistory([]); // æ¸…ç©ºå†å²è®°å½•
    setIsAnalyzing(false); // åœæ­¢åˆ†æ
    localStorage.removeItem('ai_governance_session_id'); // æ¸…é™¤æœ¬åœ°å­˜å‚¨çš„ä¼šè¯ID
  };

  // ğŸ”§ ä¿å­˜å½“å‰ä¼šè¯çŠ¶æ€åˆ°å­˜å‚¨
  const saveCurrentSessionState = (sessionId: string | null) => {
    if (!sessionId) return;
    
    console.log('ğŸ’¾ ä¿å­˜ä¼šè¯çŠ¶æ€:', sessionId, 'å†å²è®°å½•æ•°:', chatHistory.length, 'æ˜¯å¦åˆ†æä¸­:', isAnalyzing);
    setSessionStates(prev => ({
      ...prev,
      [sessionId]: {
        chatHistory: [...chatHistory],
        isAnalyzing: isAnalyzing
      }
    }));
  };
  
  // ğŸ”§ ä»å­˜å‚¨æ¢å¤ä¼šè¯çŠ¶æ€
  const restoreSessionState = (sessionId: string) => {
    const savedState = sessionStates[sessionId];
    if (savedState) {
      console.log('ğŸ“‚ æ¢å¤ä¼šè¯çŠ¶æ€:', sessionId, 'å†å²è®°å½•æ•°:', savedState.chatHistory.length, 'æ˜¯å¦åˆ†æä¸­:', savedState.isAnalyzing);
      setChatHistory(savedState.chatHistory);
      setIsAnalyzing(savedState.isAnalyzing);
      return true;
    }
    return false;
  };
  
  // é—®é¢˜4ä¿®å¤ï¼šåŠ è½½ä¼šè¯å†å²è®°å½•
  const loadSessionHistory = async (sessionId: string) => {
    console.log('ğŸ”„ åŠ è½½ä¼šè¯å†å²:', sessionId);
    
    // ğŸ”§ å…ˆå°è¯•ä»å‰ç«¯çŠ¶æ€æ¢å¤ï¼ˆåŒ…å«æœªä¿å­˜çš„åˆ†æä¸­å†…å®¹ï¼‰
    const restored = restoreSessionState(sessionId);
    if (restored) {
      console.log('âœ… ä»å‰ç«¯çŠ¶æ€æ¢å¤æˆåŠŸ');
      // ä»ç„¶ä»åç«¯åŠ è½½ï¼Œä»¥è·å–æœ€æ–°çš„å·²ä¿å­˜å†…å®¹
    }
    
    try {
      const result = await httpClient.get(`/context/session/${sessionId}`);
      console.log('ğŸ“¦ åç«¯è¿”å›æ•°æ®:', result);
      
      if (result.success && result.data && result.data.taskHistory) {
        const taskHistory = Array.isArray(result.data.taskHistory) ? result.data.taskHistory : [];
        
        if (taskHistory.length === 0) {
          console.log('âš ï¸ ä¼šè¯æ— åç«¯å†å²è®°å½•');
          if (!restored) {
            setChatHistory([]);
            setIsAnalyzing(false);
          }
          return;
        }
        
        // åç«¯è¿”å›çš„æ˜¯æœ€æ–°çš„åœ¨å‰ï¼ˆDESCï¼‰ï¼Œéœ€è¦åè½¬ä¸ºæœ€æ—§çš„åœ¨å‰
        const sortedTasks = [...taskHistory].reverse();
        
        const history = sortedTasks.flatMap((task: any) => {
          const messages = [];
          
          // ç”¨æˆ·æ¶ˆæ¯
          if (task.taskDescription) {
            messages.push({ 
              role: 'user' as const, 
              text: task.taskDescription 
            });
          }
          
          // AI æ¶ˆæ¯
          if (task.outputData) {
            const modelUsed = task.outputData.modelUsed || task.modelUsed || 'AI';
            const summary = task.outputData.summary || `åˆ†æå·²å®Œæˆã€‚æ¨¡å‹ä½¿ç”¨ [${modelUsed}] å®Œæˆäº†å»ºæ¨¡æ¨æ¼”ã€‚`;
            messages.push({ 
              role: 'ai' as const, 
              text: summary,
              result: task.outputData
            });
          }
          
          return messages;
        });
        
        console.log('âœ… ä¼šè¯å†å²åŠ è½½å®Œæˆ:', history.length, 'æ¡æ¶ˆæ¯');
        
        // ğŸ”§ å¦‚æœå‰ç«¯æœ‰æœªä¿å­˜çš„åˆ†æä¸­å†…å®¹ï¼Œåˆå¹¶å®ƒä»¬
        const savedState = sessionStates[sessionId];
        if (savedState && savedState.chatHistory.length > history.length) {
          console.log('ğŸ”€ åˆå¹¶å‰ç«¯æœªä¿å­˜çš„å†…å®¹');
          setChatHistory(savedState.chatHistory);
        } else {
          setChatHistory(history);
          setIsAnalyzing(false); // åç«¯å·²å®Œæˆï¼Œä¸å†åˆ†æä¸­
        }
      } else {
        console.log('âš ï¸ æ— æ•ˆçš„å“åº”æ•°æ®');
        if (!restored) {
          setChatHistory([]);
          setIsAnalyzing(false);
        }
      }
    } catch (error) {
      console.error('âŒ åŠ è½½ä¼šè¯å†å²å¤±è´¥:', error);
      if (!restored) {
        setChatHistory([]);
        setIsAnalyzing(false);
      }
    }
  };

  // é—®é¢˜1ä¿®å¤ï¼šé€‰æ‹©ä¼šè¯æ—¶ç«‹å³åŠ è½½å†å²
  const handleSelectSession = async (id: string) => {
    console.log('ğŸ”„ åˆ‡æ¢åˆ°ä¼šè¯:', activeSessionId, '->', id);
    
    // ğŸ”§ ä¿å­˜å½“å‰ä¼šè¯çŠ¶æ€ï¼ˆåŒ…æ‹¬åˆ†æä¸­çš„å†…å®¹ï¼‰
    if (activeSessionId) {
      saveCurrentSessionState(activeSessionId);
    }
    
    // åˆ‡æ¢åˆ°æ–°ä¼šè¯
    setActiveSessionId(id);
    localStorage.setItem('ai_governance_session_id', id);
    
    // åŠ è½½æ–°ä¼šè¯çš„å†å²ï¼ˆä¼šå°è¯•ä»å‰ç«¯çŠ¶æ€æ¢å¤ï¼‰
    await loadSessionHistory(id);
  };

  const handleCreateSession = async () => {
    if (!activeDomainId) return null;

    // å¦‚æœå½“å‰å·²æœ‰æ´»åŠ¨ä¼šè¯ä¸”æ— å¯¹è¯å†å²ï¼ˆç©ºä¼šè¯ï¼‰ï¼Œåˆ™ç›´æ¥å¤ç”¨ï¼Œä¸åˆ›å»ºæ–°ä¼šè¯
    if (activeSessionId && chatHistory.length === 0 && !isAnalyzing) {
      console.log('å½“å‰ä¼šè¯ä¸ºç©ºï¼Œå¤ç”¨å½“å‰ä¼šè¯:', activeSessionId);
      return activeSessionId;
    }
    
    // ğŸ”§ ä¿å­˜å½“å‰ä¼šè¯çŠ¶æ€ï¼ˆåŒ…æ‹¬åˆ†æä¸­çš„å†…å®¹ï¼‰
    if (activeSessionId) {
      saveCurrentSessionState(activeSessionId);
    }
    
    const domain = domains.find(d => d.id === activeDomainId);
    if (!domain) return null;

    setIsCreatingSession(true);
    try {
      const sessionId = await sessionService.createSession(domain.id, domain.name);
      const newSessions = await sessionService.getUserSessions(domain.id);
      setSessions(newSessions);
      setActiveSessionId(sessionId);
      localStorage.setItem('ai_governance_session_id', sessionId);
      
      // æ–°ä¼šè¯ï¼Œæ¸…ç©ºçŠ¶æ€
      setChatHistory([]);
      setIsAnalyzing(false);
      
      return sessionId;
    } catch (error) {
      console.error('åˆ›å»ºä¼šè¯å¤±è´¥:', error);
      alert('åˆ›å»ºä¼šè¯å¤±è´¥');
      return null;
    } finally {
      setIsCreatingSession(false);
    }
  };

  const handleDeleteSession = async (sessionId: string) => {
    if (window.confirm('ç¡®å®šè¦åˆ é™¤è¯¥ä¼šè¯å—ï¼Ÿ')) {
      try {
        await sessionService.deleteSession(sessionId);
        setSessions(prev => prev.filter(s => s.sessionId !== sessionId));
        
        // ğŸ”§ åˆ é™¤ä¼šè¯çŠ¶æ€å­˜å‚¨
        setSessionStates(prev => {
          const newStates = { ...prev };
          delete newStates[sessionId];
          return newStates;
        });
        
        if (activeSessionId === sessionId) {
          setActiveSessionId(null);
          setChatHistory([]);
          setIsAnalyzing(false);
        }
      } catch (error) {
        console.error('åˆ é™¤ä¼šè¯å¤±è´¥:', error);
        alert('åˆ é™¤ä¼šè¯å¤±è´¥');
      }
    }
  };

  const handleAddSource = async (type: SourceType, name: string, content: string) => {
    if (!activeDomainId) {
      alert('âš ï¸ è¯·å…ˆé€‰æ‹©ä¸€ä¸ªä¸šåŠ¡æ•°æ®åŸŸ');
      return;
    }
    
    try {
      const newSource = await sourceService.createSource(activeDomainId, name, type, content);
      setSources(prev => [newSource, ...prev]);
      
      // æ·»åŠ æˆåŠŸæç¤º
      console.log(`âœ… èµ„äº§ "${name}" å·²æˆåŠŸæ¥å…¥åˆ°åŸŸ "${activeDomain?.name}"`);
    } catch (error) {
      console.error('åˆ›å»ºèµ„äº§å¤±è´¥:', error);
      alert('åˆ›å»ºèµ„äº§å¤±è´¥');
    }
  };

  const handleStartGovernance = async (prompt: string) => {
    if (!activeDomainId) {
      setChatHistory(prev => [...prev, { role: 'ai', text: "è¯·å…ˆåœ¨å·¦ä¾§é€‰æ‹©æˆ–åˆ›å»ºä¸€ä¸ªä¸šåŠ¡æ•°æ®åŸŸã€‚" }]);
      return;
    }
    
    if (activeDomainSources.length === 0) {
      setChatHistory(prev => [...prev, { role: 'ai', text: `åœ¨ [${activeDomain?.name}] ä¸šåŠ¡åŸŸä¸‹æš‚æ— æ•°æ®èµ„äº§ã€‚è¯·å…ˆæ¥å…¥å…ƒæ•°æ®ä»¥ä¾›åˆ†æã€‚` }]);
      return;
    }

    // è‡ªåŠ¨åˆ›å»ºä¼šè¯é€»è¾‘
    let currentSessionId = activeSessionId;
    if (!currentSessionId) {
      currentSessionId = await handleCreateSession();
      if (!currentSessionId) {
        setChatHistory(prev => [...prev, { role: 'ai', text: "è‡ªåŠ¨åˆ›å»ºä¼šè¯å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨åˆ›å»ºä¼šè¯åå†è¯•ã€‚" }]);
        return;
      }
    }
    
    setIsAnalyzing(true);
    setChatHistory(prev => [...prev, { role: 'user', text: prompt }]);

    try {
      const sourceContext = activeDomainSources.map(s => `[èµ„äº§ç±»å‹: ${s.type}, èµ„äº§åç§°: ${s.name}]\nèµ„äº§å†…å®¹: ${s.content}`).join('\n\n');
      const result = await performGovernanceAnalysis(sourceContext, prompt, aiSettings);
      
      setGovernanceResult(result);
      
      // å…ˆç»“æŸåˆ†æçŠ¶æ€ï¼Œé¿å… ThinkingLog é‡å æ˜¾ç¤º
      setIsAnalyzing(false);
      
      const modelName = result.modelUsed || aiSettings.modelName;

      setChatHistory(prev => [...prev, { 
        role: 'ai', 
        text: `åˆ†æå·²å®Œæˆã€‚æ¨¡å‹ä½¿ç”¨ [${modelName}] å®Œæˆäº†å»ºæ¨¡æ¨æ¼”ã€‚`,
        result: result 
      }]);
    } catch (error: any) {
      console.error(error);
      setIsAnalyzing(false);
      setChatHistory(prev => [...prev, { role: 'ai', text: `åˆ†æå‡ºé”™: ${error.message || "è¯·æ±‚å¤±è´¥"}` }]);
    }
  };

  return (
    <div className={`flex h-screen w-full overflow-hidden transition-colors duration-300 ${theme === 'dark' ? 'dark bg-[#141414] text-slate-300' : 'bg-[#f5f5f5] text-slate-900'}`}>
      {/* Header - åœ¨åµŒå…¥æ¨¡å¼ä¸‹éšè— */}
      {!isEmbedded && (
        <header className={`fixed top-0 left-0 right-0 h-16 border-b flex items-center px-6 z-50 transition-colors ${theme === 'dark' ? 'bg-[#141414] border-[#303030]' : 'bg-white border-[#f0f0f0] shadow-sm'}`}>
          <div className="flex items-center gap-8 h-full">
            <UinoLogo theme={theme} />
            <nav className="flex items-center h-full">
              {navItems.map((item) => (
                <button
                  key={item.path}
                  onClick={() => navigate(item.path)}
                  className={`relative px-4 h-full text-[13px] font-semibold transition-colors ${
                    location.pathname.startsWith(item.path)
                      ? (theme === 'dark' ? 'text-[#177ddc]' : 'text-[#1677ff]')
                      : (theme === 'dark' ? 'text-slate-500 hover:text-white' : 'text-slate-500 hover:text-[#1677ff]')
                  }`}
                >
                  {item.label}
                  {location.pathname.startsWith(item.path) && (
                    <span className={`absolute bottom-0 left-4 right-4 h-0.5 rounded-t-full transition-colors ${theme === 'dark' ? 'bg-[#177ddc] shadow-[0_0_8px_#177ddc]' : 'bg-[#1677ff]'}`}></span>
                  )}
                </button>
              ))}
            </nav>
          </div>
          <div className="ml-auto flex items-center gap-4">
            <div className={`flex items-center gap-2 px-3 py-1.5 rounded-lg border transition-all ${theme === 'dark' ? 'bg-[#1d1d1d] border-[#303030]' : 'bg-gray-100 border-gray-200'}`}>
              <Key size={14} className={theme === 'dark' ? 'text-slate-400' : 'text-slate-500'} />
              <input 
                type="text" 
                placeholder="è¾“å…¥ Token..." 
                value={token}
                onChange={(e) => handleTokenChange(e.target.value)}
                disabled={isTokenLocked}
                className={`bg-transparent outline-none text-xs font-mono w-32 ${theme === 'dark' ? 'text-white placeholder-slate-600' : 'text-slate-900 placeholder-slate-400'} ${isTokenLocked ? 'opacity-50 cursor-not-allowed' : ''}`}
              />
              <button 
                onClick={isTokenLocked ? handleTokenUnlock : handleTokenLock}
                className={`p-1 rounded hover:bg-white/10 transition-colors ${theme === 'dark' ? 'text-slate-400 hover:text-white' : 'text-slate-500 hover:text-slate-900'}`}
                title={isTokenLocked ? "è§£é” Token" : "ç¡®è®¤å¹¶é”å®š Token"}
              >
                {isTokenLocked ? <Lock size={12} /> : <Unlock size={12} />}
              </button>
            </div>
            <button 
              onClick={() => setShowSettings(true)}
              className={`flex items-center gap-2 px-3 py-1.5 rounded-lg border transition-all text-xs font-bold ${theme === 'dark' ? 'bg-[#1d1d1d] border-[#303030] text-slate-300 hover:text-white' : 'bg-gray-100 border-gray-200 text-slate-600 hover:bg-white hover:border-blue-400'}`}
            >
              <SettingsIcon size={14} />
              AI é…ç½®
            </button>
            <button 
              onClick={toggleTheme}
              className={`p-2 rounded-full transition-all ${theme === 'dark' ? 'bg-[#1d1d1d] text-yellow-400 border border-[#303030]' : 'bg-gray-100 text-slate-600 border border-gray-200'}`}
            >
              {theme === 'dark' ? <Sun size={18} /> : <Moon size={18} />}
            </button>
          </div>
        </header>
      )}

      <main className={`flex w-full h-full relative ${!isEmbedded ? 'pt-16' : ''}`}>
        {!isTokenLocked ? (
          <div className={`flex-1 flex flex-col items-center justify-center h-full transition-colors ${theme === 'dark' ? 'bg-[#141414] text-slate-400' : 'bg-gray-50 text-slate-500'}`}>
            <div className="text-center space-y-4 p-10 max-w-md">
              <div className={`w-20 h-20 mx-auto rounded-3xl flex items-center justify-center mb-6 ${theme === 'dark' ? 'bg-[#1d1d1d] text-blue-500' : 'bg-white text-blue-600 shadow-lg'}`}>
                <Key size={40} />
              </div>
              <h2 className={`text-2xl font-bold ${theme === 'dark' ? 'text-white' : 'text-slate-900'}`}>éœ€è¦è®¿é—®ä»¤ç‰Œ</h2>
              <p className="text-sm leading-relaxed opacity-80">
                è¯·åœ¨å³ä¸Šè§’è¾“å…¥æ‚¨çš„ Token å¹¶ç‚¹å‡»é”å®šå›¾æ ‡ä»¥è®¿é—®ç³»ç»Ÿã€‚<br/>
                Token ç”¨äºéš”ç¦»æ‚¨çš„æ•°æ®åŸŸã€ä¼šè¯è®°å½•å’Œé…ç½®ä¿¡æ¯ã€‚
              </p>
              <div className={`mt-8 p-4 rounded-xl text-xs font-mono text-left ${theme === 'dark' ? 'bg-black/50 border border-[#303030]' : 'bg-white border border-gray-200'}`}>
                <div className="flex items-center gap-2 mb-2 opacity-50">
                  <ShieldCheck size={12} />
                  <span>å®‰å…¨æç¤º</span>
                </div>
                <p>ç³»ç»Ÿä¸ä¼šä¿å­˜æ‚¨çš„ Token åˆ°æœåŠ¡å™¨ï¼Œä»…ç”¨äºè¯·æ±‚éªŒè¯å’Œæ•°æ®éš”ç¦»ã€‚</p>
              </div>
            </div>
          </div>
        ) : (
          <>
        {/* Sidebar - åœ¨åµŒå…¥æ¨¡å¼ä¸‹éšè— */}
        {!isEmbedded && (
          <aside className={`w-80 h-full border-r flex-shrink-0 transition-colors ${theme === 'dark' ? 'bg-[#141414] border-[#303030]' : 'bg-white border-[#f0f0f0]'}`}>
            <SourceSidebar 
              domains={domains}
              sources={activeDomainSources}
              activeDomainId={activeDomainId}
              onAddDomain={handleAddDomain}
                  onDeleteDomain={handleDeleteDomain}
              onSelectDomain={handleSelectDomain}
              onAddSource={handleAddSource} 
              onSelectSource={setSelectedSource}
              activeSourceId={selectedSource?.id}
              theme={theme}
            />
          </aside>
        )}

        <section className={`flex-1 h-full overflow-hidden relative transition-colors ${theme === 'dark' ? 'bg-black' : 'bg-gray-50'}`}>
          <Routes>
            <Route path="/governance" element={
              <div className="h-full flex flex-col">
                    {activeDomain && !isEmbedded && (
                      <div className={`px-8 py-3 border-b flex items-center justify-between transition-colors ${theme === 'dark' ? 'bg-[#141414] border-[#303030]' : 'bg-white border-[#f0f0f0]'}`}>
                        <div className="flex items-center gap-3">
                          <LayoutDashboard className={`w-4 h-4 ${theme === 'dark' ? 'text-blue-400' : 'text-blue-600'}`} />
                          <span className={`text-xs font-bold uppercase tracking-widest ${theme === 'dark' ? 'text-white' : 'text-slate-700'}`}>å½“å‰æ²»æ•°åŸŸ: {activeDomain.name}</span>
                        </div>
                        <div className="flex items-center gap-2">
                          <span className="text-[10px] font-bold text-slate-400">å·²æ¥å…¥èµ„äº§: {activeDomainSources.length}</span>
                        </div>
                      </div>
                    )}
                    <ErrorBoundary>
                    <AnalysisCenter 
                      isAnalyzing={isAnalyzing} 
                      chatHistory={chatHistory} 
                      onAnalyze={handleStartGovernance} 
                      onOpenSettings={() => setShowSettings(true)}
                      activeDomainName={activeDomain?.name || "æœªçŸ¥ä¸šåŠ¡åŸŸ"}
                        activeSessionId={activeSessionId}
                      aiSettings={aiSettings}
                      theme={theme}
                        sessions={sessions}
                        onSelectSession={handleSelectSession}
                        onCreateSession={handleCreateSession}
                        onDeleteSession={handleDeleteSession}
                        isCreatingSession={isCreatingSession}
                        selectedSource={selectedSource}
                      />
                    </ErrorBoundary>
              </div>
            } />
            
            <Route path="/objects" element={<div className="p-10 text-center"><h2 className="text-2xl font-bold">å¯¹è±¡ç®¡ç†æ¨¡å—</h2><p className="mt-4 text-slate-500">è¯¥åŠŸèƒ½æ­£åœ¨ä»æ²»æ•°ç»“æœä¸­åŒæ­¥...</p></div>} />
            <Route path="/glossary" element={<div className="p-10 text-center"><h2 className="text-2xl font-bold">ä¸šåŠ¡æœ¯è¯­è¡¨</h2><p className="mt-4 text-slate-500">æŸ¥çœ‹å·²æ²‰æ·€çš„ä¸šåŠ¡è§„èŒƒæœ¯è¯­</p></div>} />
            <Route path="*" element={<Navigate to="/governance" replace />} />
          </Routes>
        </section>

        <aside className={`${isEmbedded ? 'w-[400px]' : 'w-[460px]'} h-full border-l flex-shrink-0 transition-colors ${theme === 'dark' ? 'bg-[#141414] border-[#303030]' : 'bg-white border-[#f0f0f0]'}`}>
              <ErrorBoundary>
                <GovernanceStudio result={governanceResult} theme={theme} selectedSource={selectedSource} />
              </ErrorBoundary>
        </aside>
          </>
        )}
      </main>

      {/* Settings Modal */}
      {showSettings && (
        <div className="fixed inset-0 z-[1000] flex items-center justify-center p-4">
          <div className="absolute inset-0 bg-black/70 backdrop-blur-md" onClick={() => setShowSettings(false)}></div>
          <div className={`relative w-full max-w-lg rounded-[40px] border shadow-[0_25px_80px_rgba(0,0,0,0.5)] overflow-hidden animate-in zoom-in duration-300 ${theme === 'dark' ? 'bg-[#141414] border-[#303030]' : 'bg-white border-gray-200'}`}>
            <div className="p-10">
              <div className="flex justify-between items-center mb-10">
                <div>
                  <h3 className={`text-2xl font-bold tracking-tight ${theme === 'dark' ? 'text-white' : 'text-slate-900'}`}>AI æ ¸å¿ƒå¼•æ“é…ç½®</h3>
                  <p className="text-[11px] text-slate-500 mt-1 uppercase tracking-widest font-black">å®šä¹‰æ²»æ•°å¤§æ¨¡å‹çš„æ¥å…¥åè®®ä¸å‚æ•°</p>
                </div>
                <button onClick={() => setShowSettings(false)} className="p-2 text-slate-500 hover:text-white transition-colors"><X size={20} /></button>
              </div>

              <div className="space-y-8">
                <div className="space-y-4">
                  <label className="text-[10px] font-black text-slate-400 uppercase tracking-widest px-1">å¼•æ“åè®®æ¶æ„</label>
                  <div className="grid grid-cols-2 gap-4">
                    {[
                      { id: 'GEMINI_SDK', label: 'Gemini Native', desc: 'åŸç”Ÿ SDK åŠ é€Ÿ', icon: <Zap size={20} /> },
                      { id: 'OPENAI_COMPATIBLE', label: 'Universal AI', desc: 'OpenAI å…¼å®¹åè®®', icon: <Globe size={20} /> }
                    ].map(engine => (
                      <button
                        key={engine.id}
                        onClick={() => setAiSettings({...aiSettings, engine: engine.id as AIEngineType})}
                        className={`flex flex-col items-start gap-3 p-5 rounded-3xl border-2 transition-all ${
                          aiSettings.engine === engine.id 
                            ? (theme === 'dark' ? 'bg-[#177ddc]/10 border-[#177ddc] text-white' : 'bg-blue-50 border-blue-500 text-blue-700') 
                            : (theme === 'dark' ? 'bg-black/40 border-[#303030] text-slate-500 hover:border-slate-600' : 'bg-gray-50 border-gray-100 text-slate-400 hover:bg-white')
                        }`}
                      >
                        <div className={`p-2 rounded-xl ${aiSettings.engine === engine.id ? 'bg-[#177ddc] text-white' : (theme === 'dark' ? 'bg-[#1d1d1d] text-slate-500' : 'bg-white text-slate-400')}`}>
                          {engine.icon}
                        </div>
                        <div>
                          <div className="text-sm font-bold">{engine.label}</div>
                          <div className="text-[10px] font-medium opacity-60">{engine.desc}</div>
                        </div>
                      </button>
                    ))}
                  </div>
                </div>

                <div className="space-y-4">
                  <div className="space-y-2">
                    <label className="text-[10px] font-black text-slate-400 uppercase tracking-widest px-1">æ¨¡å‹æ ‡è¯†ç¬¦ (Model Name)</label>
                    <input 
                      className={`w-full px-5 h-14 rounded-2xl border outline-none font-bold transition-colors ${theme === 'dark' ? 'bg-black border-[#303030] text-white focus:border-[#177ddc]' : 'bg-gray-50 border-gray-200 text-slate-900 focus:border-blue-500'}`}
                      placeholder={aiSettings.engine === 'GEMINI_SDK' ? "gemini-3-pro-preview" : "gpt-4o"}
                      value={aiSettings.modelName}
                      onChange={e => setAiSettings({...aiSettings, modelName: e.target.value})}
                    />
                  </div>

                  <div className="space-y-2">
                    <label className="text-[10px] font-black text-slate-400 uppercase tracking-widest px-1">API å¯†é’¥ (API Key)</label>
                    <input 
                      type="password"
                      className={`w-full px-5 h-14 rounded-2xl border outline-none font-mono text-xs transition-colors ${theme === 'dark' ? 'bg-black border-[#303030] text-white focus:border-[#177ddc]' : 'bg-gray-50 border-gray-200 text-slate-900 focus:border-blue-500'}`}
                      placeholder={aiSettings.engine === 'GEMINI_SDK' ? "AIza..." : "sk-..."}
                      value={aiSettings.apiKey || ''}
                      onChange={e => setAiSettings({...aiSettings, apiKey: e.target.value})}
                    />
                  </div>

                  {aiSettings.engine === 'OPENAI_COMPATIBLE' && (
                    <div className="space-y-2 animate-in slide-in-from-top-2 duration-300">
                      <label className="text-[10px] font-black text-slate-400 uppercase tracking-widest px-1">API Base URL</label>
                      <input 
                        className={`w-full px-5 h-14 rounded-2xl border outline-none font-mono text-xs transition-colors ${theme === 'dark' ? 'bg-black border-[#303030] text-white focus:border-[#177ddc]' : 'bg-gray-50 border-gray-200 text-slate-900 focus:border-blue-500'}`}
                        placeholder="https://dashscope.aliyuncs.com/compatible-mode/v1"
                        value={aiSettings.baseUrl}
                        onChange={e => setAiSettings({...aiSettings, baseUrl: e.target.value})}
                      />
                    </div>
                  )}
                </div>

                <div className={`p-5 rounded-3xl border flex items-center gap-4 transition-colors ${theme === 'dark' ? 'bg-blue-500/5 border-blue-500/20' : 'bg-blue-50 border-blue-100'}`}>
                   <div className={`w-10 h-10 rounded-full flex items-center justify-center transition-colors ${theme === 'dark' ? 'bg-blue-500/20 text-blue-400' : 'bg-blue-100 text-blue-600'}`}>
                      <ShieldCheck size={20} />
                   </div>
                   <div className="flex-1">
                      <div className={`text-[11px] font-bold ${theme === 'dark' ? 'text-blue-300' : 'text-blue-700'}`}>API å¯†é’¥æœ¬åœ°å­˜å‚¨</div>
                      <div className="text-[9px] text-slate-500 font-medium">å¯†é’¥å°†å­˜å‚¨åœ¨æµè§ˆå™¨æœ¬åœ°ï¼Œä»…ç”¨äºå½“å‰è®¾å¤‡çš„ AI è¯·æ±‚ã€‚</div>
                   </div>
                </div>

                <div className="pt-4">
                  <button 
                    onClick={() => saveSettings(aiSettings)}
                    className={`w-full py-5 rounded-3xl flex items-center justify-center gap-3 text-sm font-black uppercase tracking-[0.2em] transition-all shadow-xl group ${theme === 'dark' ? 'bg-[#177ddc] hover:bg-[#1668dc] text-white' : 'bg-blue-600 hover:bg-blue-700 text-white'}`}
                  >
                    <Save size={18} className="group-hover:scale-110 transition-transform" />
                    åº”ç”¨ AI é…ç½®å¹¶ä¿å­˜
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
      )}
    </div>
  );
};

export default App;
